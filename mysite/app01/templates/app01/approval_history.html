<!-- app01/templates/app01/approval_history.html -->
{% extends 'base.html' %}

{% block content %}
<h1>审批历史记录</h1>

<form method="get" class="mb-3">
    <div class="row">
        <div class="col-md-6">
            <input type="text" name="search" class="form-control" placeholder="搜索申请原因、申请人或步骤" value="{{ search_query }}">
        </div>
        <div class="col-md-4">
            <select name="status" class="form-control">
                <option value="">所有状态</option>
                <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>已批准</option>
                <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>已拒绝</option>
                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>待审批</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary">筛选</button>
        </div>
    </div>
</form>

<table class="table table-striped">
    <thead>
        <tr>
            <th>申请人</th>
            <th>申请原因</th>
            <th>审批步骤</th>
            <th>审批人</th>
            <th>审批状态</th>
            <th>审批时间</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
    {% for approval in page_obj %}
        <tr>
            <td>{{ approval.supply_request.employee.username }}</td>
            <td>{{ approval.supply_request.reason }}</td>
            <td>{{ approval.step.name }}</td>
            <td>{{ approval.approver.username }}</td>
            <td>
                {% if approval.is_approved == True %}
                    <span class="badge bg-success">已批准</span>
                {% elif approval.is_approved == False %}
                    <span class="badge bg-danger">已拒绝</span>
                {% else %}
                    <span class="badge bg-warning text-dark">待审批</span>
                {% endif %}
            </td>
            <td>{{ approval.updated_at|date:"Y-m-d H:i" }}</td>
            <td>
                <a href="{% url 'supply_request_detail' approval.supply_request.id %}" class="btn btn-info btn-sm">查看详情</a>
            </td>
        </tr>
    {% empty %}
        <tr>
            <td colspan="7">暂无审批记录</td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<!-- 分页 -->
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1">&laquo; 首页</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">上一页</a></li>
        {% endif %}

        <li class="page-item disabled"><a class="page-link" href="#">第 {{ page_obj.number }} 页，共 {{ page_obj.paginator.num_pages }} 页</a></li>

        {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">下一页</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">末页 &raquo;</a></li>
        {% endif %}
    </ul>
</nav>
{% endblock %}