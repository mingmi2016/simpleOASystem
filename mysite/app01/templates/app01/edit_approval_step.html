{% extends 'base.html' %}

{% block title %}编辑审批步骤{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container {
        width: 100% !important;
    }
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">编辑审批步骤</h3>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="process_name">步骤名称</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="process_name" 
                                   name="process_name" 
                                   value="{{ step.process_name }}"
                                   required>
                        </div>

                        <div class="form-group">
                            <label>审批类型</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" 
                                           type="radio" 
                                           name="is_countersign" 
                                           id="normal_approval" 
                                           value="False" 
                                           {% if not step.is_countersign %}checked{% endif %}>
                                    <label class="form-check-label" for="normal_approval">
                                        普通审批
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" 
                                           type="radio" 
                                           name="is_countersign" 
                                           id="counter_approval" 
                                           value="True" 
                                           {% if step.is_countersign %}checked{% endif %}>
                                    <label class="form-check-label" for="counter_approval">
                                        会签审批
                                    </label>
                                </div>
                            </div>
                            <small class="help-text" id="approval-type-help">
                                普通审批只能选择一位审批人，会签审批可以选择多位审批人
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="approvers">审批人</label>
                            <select name="approvers" 
                                    id="approvers" 
                                    class="form-control select2" 
                                    {% if step.is_countersign %}multiple{% endif %}
                                    required>
                                {% if not step.is_countersign %}
                                    <option value="">请选择审批人</option>
                                {% endif %}
                                {% for user in users %}
                                    <option value="{{ user.id }}" 
                                            {% if user in step.approvers.all %}selected{% endif %}>
                                        {{ user.username }}
                                    </option>
                                {% endfor %}
                            </select>
                            <small class="help-text" id="approver-help"></small>
                        </div>

                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">保存</button>
                            <a href="{% url 'approval_process_settings' %}" class="btn btn-secondary ml-2">返回</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    function initSelect2(isCountersign) {
        $('#approvers').select2({
            placeholder: isCountersign ? '选择多位审批人' : '选择一位审批人',
            allowClear: true,
            multiple: isCountersign,
            language: {
                noResults: function() {
                    return '没有找到匹配的用户';
                },
                searching: function() {
                    return '搜索中...';
                }
            },
            minimumInputLength: 1,  // 至少输入1个字符才开始搜索
            maximumSelectionLength: isCountersign ? null : 1  // 普通审批限制只能选1个
        }).val(null).trigger('change');
        
        // 恢复已选择的审批人
        var selectedUsers = [
            {% for user in step.approvers.all %}
                { id: {{ user.id }}, text: '{{ user.username }}' },
            {% endfor %}
        ];
        
        if (selectedUsers.length > 0) {
            var $select = $('#approvers');
            selectedUsers.forEach(function(user) {
                if ($select.find("option[value='" + user.id + "']").length) {
                    $select.val(user.id).trigger('change');
                } else {
                    var newOption = new Option(user.text, user.id, true, true);
                    $select.append(newOption).trigger('change');
                }
            });
        }
    }
    
    // 初始化Select2
    initSelect2($('input[name="is_countersign"]:checked').val() === 'True');
    
    // 监听审批类型切换
    $('input[name="is_countersign"]').change(function() {
        const isCountersign = $(this).val() === 'True';
        
        // 清除现有选择
        $('#approvers').select2('destroy');
        
        // 重新初始化Select2
        initSelect2(isCountersign);
        
        // 更新帮助文本
        $('#approver-help').text(isCountersign ? 
            '可以选择多位审批人' : 
            '只能选择一位审批人');
    });
    
    // 表单提交前验证
    $('form').submit(function(e) {
        const isCountersign = $('input[name="is_countersign"]:checked').val() === 'True';
        const selectedCount = $('#approvers').select2('data').length;
        
        if (isCountersign && selectedCount < 2) {
            e.preventDefault();
            alert('会签审批需要选择至少两个审批人');
            return false;
        } else if (!isCountersign && selectedCount !== 1) {
            e.preventDefault();
            alert('普通审批必须选择一个审批人');
            return false;
        }
    });
});
</script>
{% endblock %}
